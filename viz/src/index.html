<!DOCTYPE html>
<html>
  <meta charset="utf-8" />
  <head></head>

  <body>
    <div>
      <canvas id="chart"></canvas>
    </div>

    <script src="https://cdn.jsdelivr.net/combine/npm/moment@2.29.1,npm/chart.js@3.7.0,npm/chartjs-adapter-moment@1.0.0,npm/chartjs-plugin-zoom@1.2.0,npm/chartjs-plugin-streaming@2.0.0"></script>
    <script src="./utils.js"></script>
    <script src="./websocket_test.js"></script>
    <script src="./views/timeseries.js"></script>
    <script src="./views/donut.js"></script>

    <script>
      /*
        Controls whether mock data flows down the websocket or not.
        TODO: DISABLE THIS BEFORE PRODUCTIONIZING
      */
      const DEBUG = true;
      /*
        hello reader! this file is the entrypoint to the viz. By default, the timeseries view will show.
        The relevant code for this view is in 'views/timeseries.js'.

        To show a different view instead, navigate to "#{view}" in browser (e.g. http://localhost:8000/#donut )
      */
      (async function () {
        var ctx = document.getElementById("chart").getContext("2d");

        const res = await window.fetch("http://localhost:7000");
        let data = await res.json();
        // uncomment to piss denbeigh off
        //data.sort((a, b) => new Date(b.at) - new Date(a.at));
        data.reverse();
        data = data
          // Crop our data to a 24 hour window.
          .filter(fresh(moment(), 24, "hours"))
          // TODO: TAKE THIS OUT ONCE BACKEND TIMEZONES ARE FIXED:
          .map((a) => ({ ...a, at: a.at.replace("Z", "-0800") }));

        console.log(data);

        const word = (window.location.hash || "timeseries").replace("#", "");
        const func =
          "create" + (word.charAt(0).toUpperCase() + word.slice(1)) + "Chart";
        console.log(func);
        const { config, update } = window[func](data);
        var chart = new Chart(ctx, config);

        if (update && DEBUG) {
          testWebsocket_FAKE_DATA(chart, update);
        }

        function openSocket() {
          const socket = new WebSocket("ws://localhost:7000/stream");
          socket.addEventListener("open", () => {
            console.log("websocket opened");
            window.setInterval(() => {
              socket.send("ping");
            }, 15 * 1000);
          });
          socket.addEventListener("message", async (e) => {
            const server_text = await e.data.text();
            console.warn(server_text);
            if (update) update(chart, JSON.parse(server_text));
          });
          socket.addEventListener("close", () => {
            console.error(
              "SOCKET CLOSED - ATTEMPTING RECONNECT (waiting 2 sec)"
            );
            window.setTimeout(openSocket, 2000);
          });
        }
        openSocket();
      })();
    </script>
  </body>
</html>
